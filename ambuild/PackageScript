# vim: set ts=2 sw=2 tw=99 noet ft=python:
import os

builder.SetBuildFolder('package')

pluginName = MMSPlugin.plugin_name

# Root plugin folder: addons/<pluginName>/
pluginFolder = builder.AddFolder(os.path.join('addons', pluginName))

# Root bin folder: addons/<pluginName>/bin/
binRoot = builder.AddFolder(os.path.join('addons', pluginName, 'bin'))

# Pre-create platform-specific bin folders based on available compilers
platformFolders = {}

for cxx in MMSPlugin.all_targets:
    if cxx.target.arch != 'x86_64':
        continue

    if cxx.target.platform == 'windows':
        path = os.path.join('addons', pluginName, 'bin', 'win64')
    elif cxx.target.platform == 'linux':
        path = os.path.join('addons', pluginName, 'bin', 'linuxsteamrt64')
    elif cxx.target.platform == 'mac':
        path = os.path.join('addons', pluginName, 'bin', 'osx64')
    else:
        continue

    platformFolders[cxx.target.platform] = builder.AddFolder(path)

# Copy plugin binaries
for task in MMSPlugin.binaries:
    platform = task.target.platform

    if platform == 'windows':
        dest = platformFolders['windows']
    elif platform == 'linux':
        dest = platformFolders['linux']
    elif platform == 'mac':
        dest = platformFolders['mac']
    else:
        raise Exception(f"Unknown platform '{platform}' in PackageScript")

    builder.AddCopy(task.binary, dest)

# Copy configs folder recursively
configs_src = os.path.join(builder.sourcePath, '../configs')

for root, dirs, files in os.walk(configs_src):
    rel = os.path.relpath(root, configs_src)

    if rel == ".":
        folder = builder
    else:
        folder = builder.AddFolder(rel)

    for f in files:
        builder.AddCopy(os.path.join(root, f), folder)
